# Modix 本地测试说明文档

## 概述

本文档提供了 Modix 项目的完整本地测试指南，包括环境搭建、配置管理、功能测试和常见问题解决方案。

## 目录

- [环境准备](#环境准备)
- [项目构建](#项目构建)
- [配置文件设置](#配置文件设置)
- [功能测试](#功能测试)
- [API 测试](#api-测试)
- [故障排除](#故障排除)
- [测试用例](#测试用例)

## 环境准备

### 1. Rust 环境安装

```bash
# 安装 Rust (如果尚未安装)
curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh
source ~/.cargo/env

# 验证安装
rustc --version
cargo --version
```

### 2. 必要依赖

确保系统已安装以下工具：

- Git
- cURL
- JSON 处理工具 (可选)

### 3. API 密钥准备

为测试需要，准备以下 API 密钥：

| 服务提供商 | 密钥类型         | 获取方式                                               |
| ---------- | ---------------- | ------------------------------------------------------ |
| Anthropic  | Claude API Key   | [Anthropic Console](https://console.anthropic.com/)    |
| DeepSeek   | DeepSeek API Key | [DeepSeek Platform](https://platform.deepseek.com/)    |
| Alibaba    | Qwen API Key     | [Alibaba Cloud](https://dashscope.console.aliyun.com/) |
| ByteDance  | Doubao API Key   | [Volcano Engine](https://www.volcengine.com/)          |

## 项目构建

### 1. 克隆项目

```bash
git clone https://github.com/promacanthus/modix.git
cd modix
```

### 2. 初始化 Cargo 项目

```bash
# 如果 Cargo.toml 不存在，初始化项目
cargo init

# 添加必要依赖
cargo add reqwest serde clap
cargo add serde_json
cargo add tokio --features full
cargo add dirs
```

### 3. 构建项目

```bash
# 开发构建
cargo build

# 发布构建
cargo build --release

# 检查代码格式
cargo fmt

# 代码检查
cargo clippy
```

### 4. 运行测试

```bash
# 运行所有测试
cargo test

# 运行特定测试
cargo test test_name

# 运行时测试
cargo test -- --nocapture
```

## 配置文件设置

### 1. 创建配置目录

```bash
# 创建配置目录
mkdir -p ~/.claude
mkdir -p ~/.modix
```

### 2. 基础配置文件

创建 `~/.claude/settings.json`：

```json
{
  "apiEndpoint": "https://api.anthropic.com",
  "apiKey": "your-anthropic-api-key-here",
  "env": "prod"
}
```

### 3. Modix 配置文件

创建 `~/.modix/settings.json`：

```json
{
  "current_model": "Claude",
  "default_model": "Claude",
  "models": {
    "Claude": {
      "vendor": "anthropic",
      "api_endpoint": "https://api.anthropic.com",
      "api_key": "your-anthropic-api-key-here"
    },
    "DeepSeek V3.2 Exp": {
      "vendor": "deepseek",
      "api_endpoint": "https://api.deepseek.com/v1",
      "api_key": "your-deepseek-api-key-here"
    },
    "Qwen3 Coder": {
      "vendor": "alibaba",
      "api_endpoint": "https://dashscope.aliyuncs.com/api/v1",
      "api_key": "your-qwen-api-key-here"
    },
    "DouBao Seed Code": {
      "vendor": "bytedance",
      "api_endpoint": "https://open.volcanoengine.com/api/v1",
      "api_key": "your-doubao-api-key-here"
    }
  },
  "config_version": "1.0.0",
  "created_at": "2025-11-17T00:00:00Z",
  "updated_at": "2025-11-17T00:00:00Z"
}
```

### 4. 权限设置

```bash
# 设置配置文件权限
chmod 600 ~/.claude/settings.json
chmod 600 ~/.modix/settings.json

# 设置目录权限
chmod 700 ~/.claude
chmod 700 ~/.modix
```

## 功能测试

### 1. 基础命令测试

```bash
# 测试帮助信息
cargo run -- --help

# 测试版本信息
cargo run -- --version
```

### 2. 初始化测试

```bash
# 初始化配置
cargo run -- init

# 验证配置文件创建
ls -la ~/.modix/settings.json
cat ~/.modix/settings.json
```

### 3. 模型列表测试

```bash
# 列出所有模型
cargo run -- list

# 预期输出示例：
# NAME                           VENDOR          ENDPOINT
# Claude                         anthropic       https://api.anthropic.com
# DeepSeek V3.2 Exp              deepseek        https://api.deepseek.com/v1
# Qwen3 Coder                    alibaba         https://dashscope.aliyuncs.com/api/v1
# DouBao Seed Code               bytedance       https://open.volcanoengine.com/api/v1
```

### 4. 模型切换测试

```bash
# 切换到 Claude 官方 API
cargo run -- switch Claude

# 验证切换结果
cargo run -- status

# 切换到 DeepSeek
cargo run -- switch "DeepSeek V3.2 Exp"

# 验证 Claude 配置文件更新
cat ~/.claude/settings.json
```

### 5. 状态查询测试

```bash
# 查看当前状态
cargo run -- status

# 预期输出示例：
# Current model: Claude
# Provider: anthropic
# API Endpoint: https://api.anthropic.com
```

### 6. 配置路径测试

```bash
# 显示配置文件路径
cargo run -- path

# 预期输出：
# Configuration file path: /Users/username/.modix/settings.json
```

## API 测试

### 1. 网络连通性测试

```bash
# 测试 Anthropic API 连通性
curl -I https://api.anthropic.com

# 测试 DeepSeek API 连通性
curl -I https://api.deepseek.com

# 测试 Alibaba API 连通性
curl -I https://dashscope.aliyuncs.com/api/v1
```

### 2. API 密钥验证测试

```bash
# 测试 Claude API 密钥
curl -H "x-api-key: your-anthropic-api-key-here" \
     -H "Content-Type: application/json" \
     -d '{"model":"claude-3-opus-20240229","messages":[{"role":"user","content":"test"}]}' \
     https://api.anthropic.com/v1/messages

# 测试 DeepSeek API 密钥
curl -H "Authorization: Bearer your-deepseek-api-key-here" \
     -H "Content-Type: application/json" \
     -d '{"model":"deepseek-chat","messages":[{"role":"user","content":"test"}]}' \
     https://api.deepseek.com/v1/chat/completions
```

### 3. 模拟 API 调用测试

创建测试脚本 `test_api.sh`：

```bash
#!/bin/bash

echo "=== API 连通性测试 ==="

# 测试 Anthropic
echo "Testing Anthropic API..."
curl -s -o /dev/null -w "Anthropic: %{http_code}\n" -I https://api.anthropic.com

# 测试 DeepSeek
echo "Testing DeepSeek API..."
curl -s -o /dev/null -w "DeepSeek: %{http_code}\n" -I https://api.deepseek.com

# 测试 Alibaba
echo "Testing Alibaba API..."
curl -s -o /dev/null -w "Alibaba: %{http_code}\n" -I https://dashscope.aliyuncs.com

echo "=== 测试完成 ==="
```

运行测试：

```bash
chmod +x test_api.sh
./test_api.sh
```

## 故障排除

### 1. 常见错误及解决方案

#### 错误：配置文件不存在

```bash
# 解决方案：重新初始化
rm -rf ~/.modix
cargo run -- init
```

#### 错误：权限不足

```bash
# 解决方案：修复权限
chmod 700 ~/.modix
chmod 600 ~/.modix/settings.json
chmod 700 ~/.claude
chmod 600 ~/.claude/settings.json
```

#### 错误：网络连接失败

```bash
# 检查网络连接
ping api.anthropic.com

# 检查防火墙设置
# 确保出站连接到以下端点允许：
# - api.anthropic.com:443
# - api.deepseek.com:443
# - dashscope.aliyuncs.com:443
```

#### 错误：API 密钥无效

```bash
# 验证 API 密钥格式
# Anthropic: sk-ant-xxx...
# DeepSeek: sk-xxx...
# Alibaba: xxx...
```

### 2. 日志调试

启用详细日志：

```bash
# 设置环境变量
export RUST_LOG=debug

# 运行命令
cargo run -- list
```

### 3. 配置验证

创建配置验证脚本：

```bash
#!/bin/bash

echo "=== 配置文件验证 ==="

# 检查配置文件存在性
if [ -f ~/.modix/settings.json ]; then
    echo "✓ Modix 配置文件存在"
else
    echo "✗ Modix 配置文件不存在"
fi

if [ -f ~/.claude/settings.json ]; then
    echo "✓ Claude 配置文件存在"
else
    echo "✗ Claude 配置文件不存在"
fi

# 验证 JSON 格式
echo "验证 JSON 格式..."
if jq empty ~/.modix/settings.json 2>/dev/null; then
    echo "✓ Modix 配置文件 JSON 格式正确"
else
    echo "✗ Modix 配置文件 JSON 格式错误"
fi

if jq empty ~/.claude/settings.json 2>/dev/null; then
    echo "✓ Claude 配置文件 JSON 格式正确"
else
    echo "✗ Claude 配置文件 JSON 格式错误"
fi

echo "=== 验证完成 ==="
```

## 测试用例

### 1. 单元测试

在 `src/tests.rs` 中添加测试用例：

```rust
#[cfg(test)]
mod tests {
    use super::*;
    use std::fs;
    use tempfile::TempDir;

    #[test]
    fn test_config_creation() {
        let temp_dir = TempDir::new().unwrap();
        let config_path = temp_dir.path().join("settings.json");

        // 测试配置文件创建
        assert!(!config_path.exists());
        // ... 测试逻辑
    }

    #[test]
    fn test_model_switching() {
        // 测试模型切换逻辑
        // ... 测试逻辑
    }

    #[test]
    fn test_api_validation() {
        // 测试 API 验证
        // ... 测试逻辑
    }
}
```

### 2. 集成测试

创建集成测试脚本 `integration_test.sh`：

```bash
#!/bin/bash

set -e  # 遇到错误立即退出

echo "=== 集成测试开始 ==="

# 清理环境
rm -rf ~/.modix-test
mkdir -p ~/.modix-test

# 设置测试配置
export MODIX_CONFIG_DIR=~/.modix-test

# 测试初始化
echo "测试初始化..."
cargo run -- init
if [ $? -eq 0 ]; then
    echo "✓ 初始化成功"
else
    echo "✗ 初始化失败"
    exit 1
fi

# 测试模型列表
echo "测试模型列表..."
cargo run -- list
if [ $? -eq 0 ]; then
    echo "✓ 模型列表成功"
else
    echo "✗ 模型列表失败"
    exit 1
fi

# 测试模型切换
echo "测试模型切换..."
cargo run -- switch Claude
if [ $? -eq 0 ]; then
    echo "✓ 模型切换成功"
else
    echo "✗ 模型切换失败"
    exit 1
fi

# 清理测试环境
rm -rf ~/.modix-test

echo "=== 所有集成测试通过 ==="
```

### 3. 性能测试

创建性能测试脚本：

```bash
#!/bin/bash

echo "=== 性能测试 ==="

# 测试配置文件读取性能
echo "测试配置文件读取性能..."
time for i in {1..100}; do
    cargo run -- list > /dev/null
done

# 测试模型切换性能
echo "测试模型切换性能..."
time for i in {1..50}; do
    cargo run -- switch claude-official > /dev/null
    cargo run -- switch deepseek-v3.1 > /dev/null
done

echo "=== 性能测试完成 ==="
```

## 测试报告模板

创建测试报告模板 `test_report_template.md`：

```markdown
# Modix 测试报告

## 测试信息
- **测试日期**: YYYY-MM-DD
- **测试环境**: macOS/Linux/Windows
- **Rust 版本**: rustc X.X.X
- **测试人员**: [姓名]

## 测试结果汇总

| 测试项目   | 状态 | 详情   |
| ---------- | ---- | ------ |
| 环境搭建   | ✅/❌  | [详情] |
| 配置初始化 | ✅/❌  | [详情] |
| 模型列表   | ✅/❌  | [详情] |
| 模型切换   | ✅/❌  | [详情] |
| 状态查询   | ✅/❌  | [详情] |
| API 连接   | ✅/❌  | [详情] |

## 发现的问题

### 严重问题
1. [问题描述] - [解决方案]

### 一般问题
1. [问题描述] - [解决方案]

## 改进建议

1. [改进建议]
2. [改进建议]

## 测试结论

[测试总结和发布建议]
```

## 快速开始

### 1. 一键测试脚本

创建 `quick_test.sh`：

```bash
#!/bin/bash

echo "=== Modix 快速测试 ==="

# 检查 Rust 环境
if ! command -v cargo &> /dev/null; then
    echo "错误: 未找到 Cargo，请先安装 Rust"
    exit 1
fi

# 构建项目
echo "构建项目..."
cargo build
if [ $? -ne 0 ]; then
    echo "构建失败"
    exit 1
fi

# 运行基础测试
echo "运行基础功能测试..."
cargo run -- --help > /dev/null
cargo run -- init > /dev/null
cargo run -- list > /dev/null

echo "✓ 快速测试完成"
echo "现在可以使用以下命令进行详细测试："
echo "  cargo run -- list"
echo "  cargo run -- switch <model-name>"
echo "  cargo run -- status"
```

### 2. 测试环境清理

创建 `cleanup_test.sh`：

```bash
#!/bin/bash

echo "清理测试环境..."

# 删除测试配置
rm -rf ~/.modix
rm -rf ~/.claude

# 删除测试目录
rm -rf target/debug
rm -rf target/release

echo "✓ 清理完成"
```

## 联系方式

如有测试相关问题，请联系开发团队或提交 Issue 到 GitHub 仓库。

---

**文档版本**: v1.0.0
**最后更新**: 2025-11-17
